<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thorstens Umfragen</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    <link rel="stylesheet" href="style.css">
    
</head>
    <body>
        <nav id="nav">
            <a id="overviewTabButton" onclick="onTabSelect('overviewTab')">üëÄ Umfrageansicht</a>
            <a id="statisticsTabButton" onclick="onTabSelect('statisticsTab')">üìä Umfragestatistiken</a>
            <a id="enterSurveyTabButton" onclick="onTabSelect('enterSurveyTab')">‚úíÔ∏è Umfrage eintragen</a>
            <a id="createSurveyTabButton" onclick="onTabSelect('createSurveyTab')">‚ú® Umfrage erstellen (Ohne AI)</a>
        </nav>

        <div id="overviewTab" class="tab" src="tabs/overview.html"></div>

        <div id="statisticsTab" class="tab">
            <h2 style="color: orangered; text-align: center; width: 100%;">Der Statistik-Tab ist IN ARBEIT</h2>
        </div>


        <!-- Das Popup Formular -->
        <div id="enterSurveyTab" class="tab">
            <h3 style="margin: 40px auto;">Hier kannst du vergangene Umfragen mit Ergebnissen eintragen und speichern</h3>
            <div id="s-surveyForm">
                <table>
                    <tr>
                        <td> <label>Frage</label> </td>
                        <td> <input type="text" id="s-question"> </td>
                    </tr>
                    <tr>
                        <td> <label>Max. Auswahlen</label> </td>
                        <td> <div style="display: flex; justify-content: space-between;">
                            <input type="number" min="1" max="6" value="1" oninput="updateSliderProgress(0)" id="s-maxAnswersInput" class="maxAnswersInput" usage="s">
                            <div class="input rangeContainer">
                                <span>1</span>
                                <input type="range" min="1", max="6" value="1" oninput="updateSliderProgress(1)" tabindex="-1" id="s-maxAnswersRange" class="maxAnswersRange" usage="s">
                                <span>6</span>
                            </div>
                        </div> </td>
                    </tr>
                    <tr>
                        <td> <label>Datum & Uhreit</label> </td>
                        <td> <input type="datetime-local" onclick="this.showPicker()"> </td>
                    </tr>
                    <tr>
                        <td> <label>Antwortm√∂glichkeiten</label> </td>
                        <td id="s-dynamicAnswerContainer"></td>
                    </tr>
                    <tr>
                        <td> <button onclick="onSurveyFormSubmit()" id="s-saveSurveyButton">Umfrage Speichern</button> </td>
                    </tr>
                </table>
                
            </div>
        </div>

        <div id="createSurveyTab" class="tab">
            <h3 style="margin: 40px auto;">Hier kannst du eine Umfrage f√ºrs Autodach erstellen</h3>
            <div id="c-surveyForm">
                <table>
                    <tr>
                        <td> <label>Frage</label> </td>
                        <td> <input type="text" id="c-question"> </td>
                    </tr>
                    <tr>
                        <td> <label for="c-max-selections max-selections">Max. Auswahlen</label> </td>
                        <td> <div style="display: flex; justify-content: space-between;">
                            <input type="number" min="1" max="6" value="1" oninput="updateSliderProgress(0)" id="c-maxAnswersInput" class="maxAnswersInput" usage="c">
                            <div class="input rangeContainer">
                                <span>1</span>
                                <input type="range" min="1", max="6" value="1" oninput="updateSliderProgress(1)" tabindex="-1" id="c-maxAnswersRange" class="maxAnswersRange" usage="c">
                                <span>6</span>
                            </div>
                        </div> </td>
                    </tr>
                    <tr>
                        <td> <label>Antwortm√∂glichkeiten</label> </td>
                        <td id="c-dynamicAnswerContainer"></td>
                    </tr>
                    <tr>
                        <td> <button onclick="onSurveyFormSubmit()" id="c-saveSurveyButton">Umfrage Speichern</button> </td>
                    </tr>
                </table>
                
            </div>
        </div>

        <emoji-picker id="emojiPicker" class="dark"></emoji-picker>
        
        <template id="s-answerTemplate">
            <div class="s-input-answer input-answer" style="justify-content: space-between; display: flex;">
                <button onclick="openEmoteSelector(this)">üòÄ</button>
                <input type="text" oninput="onAnswerInput(this)" usage="s">
                <button onclick="deleteAnswer(this)" tabindex="-1" disabled>‚ùå</button>
            </div>
        </template>
        <template id="c-answerTemplate">
            <div class="c-input-answer input-answer" style="justify-content: space-between; display: flex;">
                <button onclick="openEmoteSelector(this)">üòÄ</button>
                <input type="text" oninput="onAnswerInput(this)" usage="c">
                <button onclick="deleteAnswer(this)" tabindex="-1" disabled>‚ùå</button>
            </div>
        </template>
    </body>
</html>



<script>
//speichervorgang:
//nutzer gibt daten ein, inputs werden dynamisch genereiert
//bei knopfdruck onklick f√ºr speichern ausf√ºhren
//alle vorhandenen inputs auslesen und daten in classe oder ass. array speichern
//aus classe oder ass. array in datei fetchen


//
// Code for Dynamic Answer Container - works for saving and creation forms
//
const s_dynamicAnswerContainer = document.getElementById('s-dynamicAnswerContainer');
const c_dynamicAnswerContainer = document.getElementById('c-dynamicAnswerContainer');
const s_answerTemplate = document.getElementById("s-answerTemplate");
const c_answerTemplate = document.getElementById("c-answerTemplate");

// maybe i should just remove this function
function insertTemlate(parent, template) {
    const newContainer = template.content.cloneNode(true);
    parent.appendChild(newContainer);
}

function onAnswerInput(inputField) {
    const isInputFieldEmpty = inputField.value.trim() === '';
    
    // check if situation didnt change
    if (isInputFieldEmpty && inputField.wasEmpty === true) return;
    else if (!isInputFieldEmpty && inputField.wasEmpty === false) return;
    inputField.wasEmpty = isInputFieldEmpty;

    // find out if s or c input
    const inputPrefix = inputField.getAttribute("usage");

    const containers = document.getElementsByClassName(inputPrefix + '-input-answer');
    const lastContainer = containers[containers.length - 1];
    const lastInput = lastContainer.querySelector('input');

    // Wenn der Benutzer im letzten Eingabefeld etwas eingibt
    if (lastInput === inputField && !isInputFieldEmpty) {
        insertTemlate( //add new container
            document.getElementById(inputPrefix + '-dynamicAnswerContainer'), 
            document.getElementById(inputPrefix + "-answerTemplate")
        ); 
        lastContainer.lastElementChild.removeAttribute("disabled"); //enable delete button
    }
    
    //bei mehr als einem feld √ºberpr√ºfung zur entfernung des letzten
    if (containers.length < 2) return;
    const secondlastContainer = containers[containers.length - 2];
    const secondlastInput = secondlastContainer.querySelector('input');

    // √úberpr√ºfen, ob das vorletzte Eingabefeld leer ist und l√∂sche letztes
    if (secondlastInput === inputField && isInputFieldEmpty) {   
        lastContainer.remove(); //if input emtpy remove conatiner
        secondlastContainer.lastElementChild.setAttribute("disabled", "true"); //disabled delete button
    }
}

function deleteAnswer(button) {
    button.parentElement.remove();
}

insertTemlate(s_dynamicAnswerContainer, s_answerTemplate);
insertTemlate(c_dynamicAnswerContainer, c_answerTemplate);

//
// Code For max-answers range slider
//
const s_maxAnswersRange = document.getElementById("s-maxAnswersRange");
const s_maxAnswersInput = document.getElementById("s-maxAnswersInput");
const c_maxAnswersRange = document.getElementById("d-maxAnswersRange");
const c_maxAnswersInput = document.getElementById("d-maxAnswersInput");

function updateSliderProgress(isChangeFromSlider, isFromSaveMenu) {
    // if (isFromSaveMenu) {
    //     if (isChangeFromSlider) {
    //         maxAnswersInput.value = maxAnswersRange.value;
    //     }
    //     else {
    //         maxAnswersRange.value = maxAnswersInput.value;
    //     }
        
    //     let sliderProgress = (maxAnswersRange.value - maxAnswersRange.min) / (maxAnswersRange.max - maxAnswersRange.min) * 100;
    //     maxAnswersRange.style.setProperty('--progress', `${sliderProgress}%`);
    // }
    // else {
    //     if (isChangeFromSlider) {
    //         maxAnswersInput.value = maxAnswersRange.value;
    //     }
    //     else {
    //         maxAnswersRange.value = maxAnswersInput.value;
    //     }
        
    //     let sliderProgress = (maxAnswersRange.value - maxAnswersRange.min) / (maxAnswersRange.max - maxAnswersRange.min) * 100;
    //     maxAnswersRange.style.setProperty('--progress', `${sliderProgress}%`);
    // }    
}
updateSliderProgress(); // Initialer Aufruf, um den Anfangszustand zu setzen


//
// Code for Emoji-Picker
//
const emojiPicker = document.getElementById('emojiPicker');

emojiPicker.addEventListener('emoji-click', (event) => {
    const emoji = event.detail.unicode;
    emojiPicker.clickedButton.textContent = emoji;
    emojiPicker.classList.remove("visible");
});

function openEmoteSelector(clickedButton) {
    if (emojiPicker.clickedButton == clickedButton) {
        emojiPicker.classList.toggle("visible");
    }
    else {
        emojiPicker.classList.add("visible");
        emojiPicker.clickedButton = clickedButton;
        clickedButton.textContent = "üòÄ";
        
        const rect = clickedButton.getBoundingClientRect();
        emojiPicker.style.left = rect.left + "px";
        emojiPicker.style.top = rect.bottom + "px";
    }
    
}

document.body.addEventListener("keydown", function (event) {
    if (event.keyCode == 27 && emojiPicker.classList.contains("visible")) {
        emojiPicker.classList.remove("visible");
    }
});


//
// Code der noch keinen Namen hat
//
let page = "overview";

function loadMainScreen() {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
        const jsonText = event.target.result;
        const jsonDaten = JSON.parse(jsonText);
        document.getElementById('output').innerHTML = jsonToHTML(jsonDaten);
    };
    reader.readAsText(file);

    document.getElementById('mainScreen').classList.toggle("visible"); // Hinzuf√ºgen der CSS-Klasse 'hidden'
}

// Funktion zum Generieren von HTML aus JSON
function jsonToHTML(jsonData) {
    let htmlAusgabe = "";

    for (let i = 0; i < jsonData.length; i++) {
        let survey = jsonData[i];

        htmlAusgabe += '<div class="survey">';
        htmlAusgabe += `
            <div>
                <h3>${survey.question}</h3>
                <p>Umfrage vom: <strong>${survey.date}</strong></p>
            </div>
        `;

        if (survey["max-selections"] == 1) {
            htmlAusgabe += '<p>Es ist <strong>eine Auswahl</strong> m√∂glich</p>';
        }
        else {
            htmlAusgabe += `<p>Es sind <strong>${survey["max-selections"]} auswahlen</strong> m√∂glich</p>`;
        }
        
        htmlAusgabe += '<ul>';
        for (let x = 0; x < survey.answers.length; x++) {
            let answer = survey.answers[x];
            htmlAusgabe += `
                <li>
                    ${answer.symbol}  ${answer.text} <br>
                    <span style="padding-left: 28px;">‚îî <b>${answer.persons.length}</b> Stimmen: ${answer.persons}</span>
                </li>
                `;
        }
        htmlAusgabe += '</ul></div>';
    }

    return htmlAusgabe + "<br><br><br><br><br>";
}



function openSurveyForm() {
    document.getElementById('popup-form').classList.toggle("visible");
}

function onSurveyFormSubmit() {
    alert('lol\nDu w√ºrdest nicht dr√ºcken Florian');
}


function onFileSelect() {
    document.getElementById("fileButton").innerHTML = "Neu w√§hlen üìë";
    document.getElementById("fileLabel").innerHTML = "<b>" + document.getElementById("fileInput").files[0].name + "</b> ist ausgew√§hlt";

    document.getElementById("fileSelector").classList.toggle("corner");
    document.body.append(document.getElementById("fileSelector"));
    document.getElementById("greetingScreen").style.display = "none";
    loadMainScreen();
}



function onTabSelect(selectedTabId) {
    document.querySelectorAll('.tab').forEach(element => {
        element.classList.remove("visible");
    });
    document.getElementById(selectedTabId).classList.add("visible");

    document.getElementById("nav").childNodes.forEach(element => {
        if (element.nodeType === Node.ELEMENT_NODE) {
            element.classList.remove("selected");
        }   
    });
    document.getElementById(selectedTabId + "Button").classList.add("selected");
}


onTabSelect("overviewTab");
</script>
